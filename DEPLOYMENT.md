# Deployment Guide

Этот документ описывает процесс локального развертывания фронтенда и настройки туннелей Cloudflare для доступа к `chat.mup.me` и `n8n.mup.me`.

## Требования

- **Node.js**: версия 18+ (рекомендуется)
- **Cloudflared**: установленный и авторизованный (`cloudflared login`)
- **n8n**: настроенный workflow (см. `workflows/WebChat.md`)

## Архитектура и Порты

Система состоит из трех уровней:

| Сервис | Локальный порт | Публичный адрес | Описание |
|--------|----------------|-----------------|------------|
| **Chat Frontend** | `3000` | `https://chat.mup.me` | Статические файлы (HTML/CSS/JS) |
| **API Proxy** | `3001` | - | Проксирует запросы к n8n Webhook |
| **n8n** | `443` | `https://n8n.mup.me` | Бекенд (автоматизация) |

## Инструкция по запуску

Проект поддерживает автоматический запуск всех компонентов одной командой.

### Автоматический запуск (Рекомендуется)

Запустите файл в корне проекта:

```powershell
./start_server.bat
```

Этот скрипт:

1. Завершает старые процессы `node.exe` и `cloudflared.exe` (через `kill_old_processes.ps1`).
2. Запускает статический сервер на порту 3000.
3. Запускает API прокси на порту 3001.
4. Поднимает оба туннеля (`chat` и `n8n`).

### Ручной запуск компонентов

Если вам нужно запустить части системы по отдельности:

1. **Фронтенд**: `node server/static.js` (порт 3000)
2. **Туннель чата**: `cloudflared tunnel --config chat-config.yml run`
3. **Туннель n8n**: `cloudflared tunnel --config n8n-config.yml run`

## Структура приложения

- **Landing Page**: Главный экран приветствия. При нажатии "Розпочати чат" происходит переключение на View чата.
- **Webhook Logic**: Фронтенд отправляет запросы на `/webhook/chat` (через прокси на 3001), который затем перенаправляет их в n8n туннель.

## Диагностика (Troubleshooting)

### Ошибка 502 Bad Gateway

- Убедитесь, что запущен `static.js` (порт 3000).
- Убедитесь, что n8n запущен и слушает порт 443.

### Ошибка 1033 (Tunnel Error)

- Попробуйте остановить все процессы (`Ctrl+C`) и запустить `./start_server.bat` заново. Скрипт очистит "призрачные" процессы, которые могут блокировать туннель.

## Конфигурация Туннелей

Файлы `chat-config.yml` и `n8n-config.yml` содержат UUID туннелей. При смене аккаунта Cloudflare или создании новых туннелей, обновите значения `tunnel` и `credentials-file`.
